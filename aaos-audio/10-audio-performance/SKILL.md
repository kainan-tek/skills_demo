---
name: "audio-performance"
description: "Android éŸ³é¢‘æ€§èƒ½ä¼˜åŒ–è§„èŒƒï¼Œæ¶µç›–å»¶è¿Ÿä¼˜åŒ–ã€åŠŸè€—ç®¡ç†ã€mmap æ¨¡å¼ã€Fast Trackã€AAudio ä¸æ€§èƒ½åˆ†æå·¥å…·"
version: "1.0.0"
triggers: ["latency", "performance", "mmap", "Fast Track", "AAudio", "low latency", "XRUN", "underrun", "buffer size", "period size", "CPU", "power", "systrace", "atrace", "simpleperf"]
---

> å‚è€ƒæ¥æºï¼šAndroid AOSP Audio Performance Documentation

# âš¡ Android éŸ³é¢‘æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

---

## 1. éŸ³é¢‘å»¶è¿Ÿæ¦‚è¿°

### 1.1 å»¶è¿Ÿç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Audio Latency Types                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  è¾“å‡ºå»¶è¿Ÿ (Output Latency)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  App å†™å…¥ â†’ AudioFlinger â†’ HAL â†’ DSP â†’ Speaker             â”‚â”‚
â”‚  â”‚  |_________ åº”ç”¨å»¶è¿Ÿ _________|_______ ç³»ç»Ÿå»¶è¿Ÿ _______|    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  è¾“å…¥å»¶è¿Ÿ (Input Latency)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Mic â†’ DSP â†’ HAL â†’ AudioFlinger â†’ App è¯»å–                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  å¾€è¿”å»¶è¿Ÿ (Round-Trip Latency)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  è¾“å…¥å»¶è¿Ÿ + å¤„ç†å»¶è¿Ÿ + è¾“å‡ºå»¶è¿Ÿ                              â”‚â”‚
â”‚  â”‚  å…¸å‹å€¼: 20ms ~ 100ms+                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å»¶è¿Ÿæ¥æºåˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Latency Sources                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  åº”ç”¨å±‚ (App Layer)                                             â”‚
â”‚  â”œâ”€â”€ éŸ³é¢‘æ•°æ®å¤„ç†æ—¶é—´                                           â”‚
â”‚  â”œâ”€â”€ ç¼“å†²åŒºå¤§å°é€‰æ‹©                                             â”‚
â”‚  â””â”€â”€ çº¿ç¨‹è°ƒåº¦å»¶è¿Ÿ                                               â”‚
â”‚                                                                 â”‚
â”‚  Framework å±‚                                                   â”‚
â”‚  â”œâ”€â”€ AudioTrack/AudioRecord ç¼“å†²                                â”‚
â”‚  â”œâ”€â”€ AudioFlinger æ··éŸ³å¤„ç†                                      â”‚
â”‚  â”œâ”€â”€ Effects å¤„ç†                                               â”‚
â”‚  â””â”€â”€ Binder IPC å¼€é”€                                            â”‚
â”‚                                                                 â”‚
â”‚  HAL å±‚                                                         â”‚
â”‚  â”œâ”€â”€ HAL ç¼“å†²åŒº                                                 â”‚
â”‚  â”œâ”€â”€ FMQ æ•°æ®ä¼ è¾“                                               â”‚
â”‚  â””â”€â”€ ä¸é©±åŠ¨äº¤äº’                                                 â”‚
â”‚                                                                 â”‚
â”‚  å†…æ ¸å±‚                                                         â”‚
â”‚  â”œâ”€â”€ ALSA ç¼“å†²åŒº (Buffer + Period)                              â”‚
â”‚  â”œâ”€â”€ DMA ä¼ è¾“                                                   â”‚
â”‚  â””â”€â”€ ä¸­æ–­å¤„ç†                                                   â”‚
â”‚                                                                 â”‚
â”‚  ç¡¬ä»¶å±‚                                                         â”‚
â”‚  â”œâ”€â”€ Codec å¤„ç†å»¶è¿Ÿ                                             â”‚
â”‚  â”œâ”€â”€ DSP å¤„ç†å»¶è¿Ÿ                                               â”‚
â”‚  â””â”€â”€ DAC/ADC è½¬æ¢å»¶è¿Ÿ                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å„é€šé“å»¶è¿Ÿå¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Audio Path Latency Comparison                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€šé“ç±»å‹     â”‚ Buffer å¤§å°â”‚ å»¶è¿Ÿ     â”‚ åŠŸè€—     â”‚ å¡é¡¿é£é™©    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AAudio mmap   â”‚ æå°       â”‚ ~2ms     â”‚ é«˜       â”‚ æ˜“å‘ç”Ÿ      â”‚
â”‚ ULL           â”‚ å°         â”‚ ~2ms     â”‚ æä½     â”‚ é«˜æ¦‚ç‡      â”‚
â”‚ Fast Track    â”‚ å°         â”‚ ~4ms     â”‚ ä½       â”‚ ä¼˜åŠ¿å‘ç”Ÿ    â”‚
â”‚ Primary       â”‚ ä¸­         â”‚ ~20ms    â”‚ ä¸­       â”‚ è¾ƒå°‘å‘ç”Ÿ    â”‚
â”‚ Deep Buffer   â”‚ å¤§         â”‚ ~40ms    â”‚ é«˜       â”‚ å¾ˆéš¾å‘ç”Ÿ    â”‚
â”‚ Direct/Offloadâ”‚ æå¤§       â”‚ ~80ms    â”‚ æé«˜     â”‚ æéš¾å‘ç”Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Fast Track ä½å»¶è¿Ÿé€šé“

### 2.1 Fast Track ç‰¹ç‚¹

```cpp
// Fast Track é…ç½®
audio_output_flags_t flags = AUDIO_OUTPUT_FLAG_FAST;

// ç‰¹ç‚¹:
// 1. ç‹¬ç«‹çš„ Mixer çº¿ç¨‹
// 2. æ›´å°çš„ç¼“å†²åŒº
// 3. æ›´é«˜çš„çº¿ç¨‹ä¼˜å…ˆçº§
// 4. ä¸å‚ä¸æ™®é€šæ··éŸ³
// 5. æ”¯æŒ SCHED_FIFO è°ƒåº¦
```

### 2.2 Fast Track ä½¿ç”¨æ¡ä»¶

```cpp
// 1. ä½¿ç”¨ AudioTrack åˆ›å»º
AudioTrack* track = new AudioTrack(
    AUDIO_STREAM_MUSIC,
    48000,                          // é‡‡æ ·ç‡
    AUDIO_FORMAT_PCM_16_BIT,        // æ ¼å¼
    AUDIO_CHANNEL_OUT_STEREO,       // å£°é“
    0,                              // frameCount (è‡ªåŠ¨)
    AUDIO_OUTPUT_FLAG_FAST,         // Fast Track æ ‡å¿—
    nullptr,                        // callback
    0,                              // notificationFrames
    SESSION_ID_NONE
);

// 2. æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»º Fast Track
if (track->getFlags() & AUDIO_OUTPUT_FLAG_FAST) {
    ALOGD("Fast Track created successfully");
} else {
    ALOGW("Fast Track not available, fallback to normal track");
}

// 3. è®¾ç½®é«˜ä¼˜å…ˆçº§çº¿ç¨‹
setThreadPriority(PRIORITY_URGENT_AUDIO);
```

### 2.3 Fast Track ç¼“å†²åŒºé…ç½®

```cpp
// Fast Track ç¼“å†²åŒºè¦æ±‚
// - å‘¨æœŸå¤§å°: é€šå¸¸ 2-4ms
// - å‘¨æœŸæ•°: 2-4
// - æ€»ç¼“å†²: 4-16ms

// è·å– Fast Track æ¨èç¼“å†²åŒº
size_t fastFrameCount = track->getFrameCount();
size_t fastBufferSize = fastFrameCount * track->getFrameSize();

// å†™å…¥æ•°æ® (éé˜»å¡)
ssize_t written = track->write(buffer, size, false);
if (written < 0) {
    // å¤„ç† underrun
    handleUnderrun();
}
```

---

## 3. AAudio mmap æ¨¡å¼

### 3.1 AAudio ç®€ä»‹

```cpp
// AAudio æ˜¯ Android 8.0+ å¼•å…¥çš„é«˜æ€§èƒ½éŸ³é¢‘ API
// æ”¯æŒ mmap æ¨¡å¼ï¼Œç»•è¿‡ AudioFlinger ç›´æ¥è®¿é—®é©±åŠ¨

#include <aaudio/AAudio.h>

// åˆ›å»º AAudio æµ
AAudioStreamBuilder* builder;
AAudio_createStreamBuilder(&builder);

AAudioStreamBuilder_setDeviceId(builder, AAUDIO_UNSPECIFIED);
AAudioStreamBuilder_setDirection(builder, AAUDIO_DIRECTION_OUTPUT);
AAudioStreamBuilder_setSharingMode(builder, AAUDIO_SHARING_MODE_EXCLUSIVE);
AAudioStreamBuilder_setPerformanceMode(builder, AAUDIO_PERFORMANCE_MODE_LOW_LATENCY);
AAudioStreamBuilder_setFormat(builder, AAUDIO_FORMAT_PCM_I16);
AAudioStreamBuilder_setChannelCount(builder, 2);
AAudioStreamBuilder_setSampleRate(builder, 48000);
```

### 3.2 mmap æ¨¡å¼åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AAudio mmap Mode                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ä¼ ç»Ÿæ¨¡å¼ (IRQ-based)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   App   â”‚ â†’  â”‚AudioFlingerâ”‚ â†’ â”‚   HAL   â”‚ â†’ â”‚  Driver â”‚      â”‚
â”‚  â”‚         â”‚    â”‚ (æ··éŸ³)   â”‚    â”‚         â”‚    â”‚ (IRQ)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â†‘              â†‘              â†‘              â†‘            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                    å¤šæ¬¡æ•°æ®æ‹·è´                                 â”‚
â”‚                                                                 â”‚
â”‚  mmap æ¨¡å¼ (NOIRQ)                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚  â”‚   App   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚         â”‚         å…±äº«å†…å­˜                â”‚  Driver â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â†‘                                            â†‘             â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                    é›¶æ‹·è´ï¼Œç›´æ¥è®¿é—®                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 AAudio ä½¿ç”¨ç¤ºä¾‹

```cpp
// åˆ›å»ºæµ
AAudioStream* stream;
aaudio_result_t result = AAudioStreamBuilder_openStream(builder, &stream);

if (result != AAUDIO_OK) {
    ALOGE("Failed to open AAudio stream: %d", result);
    return;
}

// æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ mmap æ¨¡å¼
bool isMMap = AAudioStream_getSharingMode(stream) == AAUDIO_SHARING_MODE_EXCLUSIVE;
ALOGD("AAudio mmap mode: %s", isMMap ? "enabled" : "disabled");

// è·å–ç¼“å†²åŒºä¿¡æ¯
int32_t framesPerBurst = AAudioStream_getFramesPerBurst(stream);
int32_t bufferSize = AAudioStream_getBufferSizeInFrames(stream);

// è®¾ç½®ç¼“å†²åŒºå¤§å° (å»ºè®® 2 * framesPerBurst)
AAudioStream_setBufferSizeInFrames(stream, framesPerBurst * 2);

// å¯åŠ¨æµ
result = AAudioStream_requestStart(stream);

// å†™å…¥æ•°æ®
int64_t timeoutNanos = 1000000000;  // 1 ç§’è¶…æ—¶
int32_t framesWritten = AAudioStream_write(stream, buffer, numFrames, timeoutNanos);

// å…³é—­æµ
AAudioStream_requestStop(stream);
AAudioStream_close(stream);
AAudioStreamBuilder_delete(builder);
```

### 3.4 AAudio å›è°ƒæ¨¡å¼

```cpp
// å›è°ƒå‡½æ•°
aaudio_data_callback_result_t audioCallback(
        AAudioStream* stream,
        void* userData,
        void* audioData,
        int32_t numFrames) {
    
    // åœ¨å›è°ƒä¸­ç”ŸæˆéŸ³é¢‘æ•°æ®
    generateAudioData(audioData, numFrames);
    
    return AAUDIO_CALLBACK_RESULT_CONTINUE;
}

// è®¾ç½®å›è°ƒ
AAudioStreamBuilder_setDataCallback(builder, audioCallback, userData);
AAudioStreamBuilder_setFramesPerDataCallback(builder, framesPerCallback);
```

---

## 4. ç¼“å†²åŒºä¼˜åŒ–

### 4.1 ç¼“å†²åŒºå‚æ•°

```cpp
// ALSA ç¼“å†²åŒºå‚æ•°
struct pcm_config {
    unsigned int channels;           // å£°é“æ•°
    unsigned int rate;               // é‡‡æ ·ç‡
    unsigned int period_size;        // å‘¨æœŸå¤§å° (å¸§)
    unsigned int period_count;       // å‘¨æœŸæ•°é‡
    enum pcm_format format;          // æ ¼å¼
};

// å»¶è¿Ÿè®¡ç®—
// å»¶è¿Ÿ (ms) = period_size * period_count * 1000 / rate

// ä½å»¶è¿Ÿé…ç½®ç¤ºä¾‹ (48kHz)
struct pcm_config low_latency_config = {
    .channels = 2,
    .rate = 48000,
    .period_size = 96,      // 2ms @ 48kHz
    .period_count = 2,      // æ€»ç¼“å†² 4ms
    .format = PCM_FORMAT_S16_LE,
};

// å¹³è¡¡é…ç½®ç¤ºä¾‹
struct pcm_config balanced_config = {
    .channels = 2,
    .rate = 48000,
    .period_size = 480,     // 10ms @ 48kHz
    .period_count = 4,      // æ€»ç¼“å†² 40ms
    .format = PCM_FORMAT_S16_LE,
};
```

### 4.2 ç¼“å†²åŒºæƒè¡¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Buffer Size Trade-offs                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  å°ç¼“å†²åŒº                                                       â”‚
â”‚  â”œâ”€â”€ ä¼˜ç‚¹: ä½å»¶è¿Ÿ                                              â”‚
â”‚  â”œâ”€â”€ ç¼ºç‚¹: é«˜ CPU å ç”¨ã€æ˜“ XRUN                                â”‚
â”‚  â””â”€â”€ é€‚ç”¨: å®æ—¶éŸ³é¢‘ã€æ¸¸æˆéŸ³æ•ˆã€è¯­éŸ³é€šè¯                        â”‚
â”‚                                                                 â”‚
â”‚  å¤§ç¼“å†²åŒº                                                       â”‚
â”‚  â”œâ”€â”€ ä¼˜ç‚¹: ä½ CPU å ç”¨ã€ç¨³å®š                                   â”‚
â”‚  â”œâ”€â”€ ç¼ºç‚¹: é«˜å»¶è¿Ÿ                                              â”‚
â”‚  â””â”€â”€ é€‚ç”¨: éŸ³ä¹æ’­æ”¾ã€åå°æ’­æ”¾                                  â”‚
â”‚                                                                 â”‚
â”‚  æ¨èé…ç½®                                                       â”‚
â”‚  â”œâ”€â”€ ä½å»¶è¿Ÿåœºæ™¯: 2-4 å‘¨æœŸï¼Œæ¯å‘¨æœŸ 2-5ms                        â”‚
â”‚  â”œâ”€â”€ å¹³è¡¡åœºæ™¯: 4 å‘¨æœŸï¼Œæ¯å‘¨æœŸ 10ms                             â”‚
â”‚  â””â”€â”€ ä½åŠŸè€—åœºæ™¯: 4 å‘¨æœŸï¼Œæ¯å‘¨æœŸ 20ms                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. XRUN å¤„ç†

### 5.1 XRUN ç±»å‹

```cpp
// Underrun (æ’­æ”¾)
// - åŸå› : æ•°æ®ä¾›åº”ä¸è¶³
// - ç°è±¡: æ’­æ”¾å¡é¡¿ã€æ‚éŸ³
// - è¿”å›å€¼: -EPIPE

// Overrun (å½•éŸ³)
// - åŸå› : æ•°æ®å¤„ç†ä¸åŠæ—¶
// - ç°è±¡: æ•°æ®ä¸¢å¤±
// - è¿”å›å€¼: -EPIPE
```

### 5.2 XRUN æ£€æµ‹ä¸æ¢å¤

```cpp
// æ£€æµ‹ XRUN
snd_pcm_sframes_t frames = snd_pcm_writei(handle, buffer, size);

if (frames == -EPIPE) {
    // XRUN å‘ç”Ÿ
    ALOGW("XRUN detected: underrun occurred");
    
    // ç»Ÿè®¡ XRUN æ¬¡æ•°
    xrun_count++;
    
    // æ¢å¤
    snd_pcm_prepare(handle);
    
    // é‡æ–°å†™å…¥
    snd_pcm_writei(handle, buffer, size);
}

// ä½¿ç”¨ snd_pcm_recover è‡ªåŠ¨æ¢å¤
int err = snd_pcm_recover(handle, frames, 0);
if (err < 0) {
    ALOGE("Recovery failed: %s", snd_strerror(err));
}
```

### 5.3 XRUN é¢„é˜²

```cpp
// 1. å¢å¤§ç¼“å†²åŒº
config.period_count = 4;  // å¢åŠ å‘¨æœŸæ•°

// 2. æé«˜çº¿ç¨‹ä¼˜å…ˆçº§
setThreadPriority(PRIORITY_URGENT_AUDIO);

// 3. ä½¿ç”¨ poll ç­‰å¾…
struct pollfd pfd;
pfd.fd = pcm_get_file_descriptor(pcm);
pfd.events = POLLOUT;

while (playing) {
    int ret = poll(&pfd, 1, 1000);
    if (ret > 0) {
        snd_pcm_writei(handle, buffer, size);
    }
}

// 4. é¢„å¡«å……ç¼“å†²åŒº
for (int i = 0; i < config.period_count; i++) {
    snd_pcm_writei(handle, silence_buffer, period_size);
}
```

---

## 6. åŠŸè€—ä¼˜åŒ–

### 6.1 åŠŸè€—æ¥æº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Audio Power Consumption                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  CPU åŠŸè€—                                                       â”‚
â”‚  â”œâ”€â”€ éŸ³é¢‘æ•°æ®å¤„ç†                                               â”‚
â”‚  â”œâ”€â”€ æ··éŸ³è¿ç®—                                                   â”‚
â”‚  â”œâ”€â”€ éŸ³æ•ˆå¤„ç†                                                   â”‚
â”‚  â””â”€â”€ é¢‘ç¹å”¤é†’                                                   â”‚
â”‚                                                                 â”‚
â”‚  ç¡¬ä»¶åŠŸè€—                                                       â”‚
â”‚  â”œâ”€â”€ Codec åŠŸè€—                                                 â”‚
â”‚  â”œâ”€â”€ DSP åŠŸè€—                                                   â”‚
â”‚  â”œâ”€â”€ I2S/PCM æ€»çº¿                                               â”‚
â”‚  â””â”€â”€ åŠŸæ”¾åŠŸè€—                                                   â”‚
â”‚                                                                 â”‚
â”‚  ç³»ç»ŸåŠŸè€—                                                       â”‚
â”‚  â”œâ”€â”€ å†…å­˜è®¿é—®                                                   â”‚
â”‚  â”œâ”€â”€ DMA ä¼ è¾“                                                   â”‚
â”‚  â””â”€â”€ ä¸­æ–­å¤„ç†                                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 åŠŸè€—ä¼˜åŒ–ç­–ç•¥

```cpp
// 1. ä½¿ç”¨å¤§ç¼“å†²åŒº
// å‡å°‘ä¸­æ–­é¢‘ç‡ï¼Œé™ä½ CPU å”¤é†’æ¬¡æ•°
config.period_size = 960;   // 20ms @ 48kHz
config.period_count = 4;

// 2. ä½¿ç”¨ Deep Buffer
audio_output_flags_t flags = AUDIO_OUTPUT_FLAG_DEEP_BUFFER;

// 3. ä½¿ç”¨ Offload æ¨¡å¼ (ç¡¬ä»¶è§£ç )
flags = AUDIO_OUTPUT_FLAG_COMPRESS_OFFLOAD;

// 4. åˆç†ä½¿ç”¨ standby
void enterStandbyWhenIdle() {
    if (idle_time > STANDBY_THRESHOLD) {
        pcm_stop(pcm);
        // å…³é—­ä¸å¿…è¦çš„ç¡¬ä»¶
    }
}

// 5. åŠ¨æ€æ—¶é’Ÿè°ƒæ•´
void adjustClockForLowPower() {
    // é™ä½ DSP æ—¶é’Ÿ
    // é™ä½ I2S æ—¶é’Ÿ
    // è¿›å…¥ä½åŠŸè€—æ¨¡å¼
}
```

### 6.3 DAPM ç”µæºç®¡ç†

```c
// å†…æ ¸ DAPM é…ç½®
// è‡ªåŠ¨ç®¡ç†éŸ³é¢‘ç»„ä»¶ç”µæº

static const struct snd_soc_dapm_widget codec_dapm_widgets[] = {
    // ç”µæºåŸŸ
    SND_SOC_DAPM_SUPPLY("PLL", CODEC_PLL_CTRL, 0, 0, NULL, 0),
    SND_SOC_DAPM_SUPPLY("CLKGEN", CODEC_CLK_CTRL, 0, 0, NULL, 0),
    
    // DAC/ADC ä¾èµ–ç”µæº
    SND_SOC_DAPM_DAC("DAC", "Playback", CODEC_DAC_CTRL, 0, 0),
    SND_SOC_DAPM_ADC("ADC", "Capture", CODEC_ADC_CTRL, 0, 0),
};

static const struct snd_soc_dapm_route codec_routes[] = {
    // ç”µæºä¾èµ–å…³ç³»
    {"DAC", NULL, "PLL"},
    {"DAC", NULL, "CLKGEN"},
    {"ADC", NULL, "PLL"},
    {"ADC", NULL, "CLKGEN"},
};
```

---

## 7. æ€§èƒ½åˆ†æå·¥å…·

### 7.1 systrace / atrace

```bash
# é‡‡é›†éŸ³é¢‘ systrace
atrace --app audioflinger,audioserver -t 5 -o trace.html

# æˆ–ä½¿ç”¨ systrace
python $ANDROID/sdk/platform-tools/systrace/systrace.py \
    --app=audioflinger,audioserver \
    -t 5 \
    -o trace.html \
    audio freq sched

# åˆ†æè¦ç‚¹
# 1. AudioFlinger çº¿ç¨‹è°ƒåº¦
# 2. ç¼“å†²åŒºå¡«å……æƒ…å†µ
# 3. CPU é¢‘ç‡å˜åŒ–
# 4. çº¿ç¨‹å”¤é†’å»¶è¿Ÿ
```

### 7.2 simpleperf

```bash
# é‡‡é›†æ€§èƒ½æ•°æ®
simpleperf record -g -p $(pidof audioserver) -o perf.data --duration 10

# åˆ†æçƒ­ç‚¹å‡½æ•°
simpleperf report -i perf.data --sort comm,dso,symbol

# æŸ¥çœ‹è°ƒç”¨å›¾
simpleperf report -i perf.data -g
```

### 7.3 dumpsys

```bash
# æŸ¥çœ‹éŸ³é¢‘å»¶è¿Ÿ
dumpsys audio | grep -i latency

# æŸ¥çœ‹ç¼“å†²åŒºä¿¡æ¯
dumpsys audio | grep -i buffer

# æŸ¥çœ‹ Fast Track çŠ¶æ€
dumpsys audio | grep -i fast

# æŸ¥çœ‹ XRUN ç»Ÿè®¡
dumpsys audio | grep -i underrun
```

### 7.4 å†…æ ¸è°ƒè¯•

```bash
# æŸ¥çœ‹ ALSA çŠ¶æ€
cat /proc/asound/card0/pcm0p/sub0/status

# æŸ¥çœ‹ DMA çŠ¶æ€
cat /proc/asound/card0/pcm0p/sub0/hw_params

# å¯ç”¨ ALSA è°ƒè¯•
echo 1 > /sys/module/snd/parameters/debug

# æŸ¥çœ‹ ftrace éŸ³é¢‘äº‹ä»¶
echo 1 > /sys/kernel/debug/tracing/events/snd/enable
cat /sys/kernel/debug/tracing/trace
```

---

## 8. æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### 8.1 å»¶è¿Ÿä¼˜åŒ–

```
â–¡ ä½¿ç”¨ Fast Track æˆ– AAudio mmap æ¨¡å¼
â–¡ å‡å°ç¼“å†²åŒºå¤§å°
â–¡ æé«˜éŸ³é¢‘çº¿ç¨‹ä¼˜å…ˆçº§
â–¡ é¿å…åœ¨éŸ³é¢‘è·¯å¾„ä¸­è¿›è¡Œå¤æ‚è®¡ç®—
â–¡ ä½¿ç”¨ poll/select ç­‰å¾…è€Œéè½®è¯¢
```

### 8.2 XRUN é¢„é˜²

```
â–¡ å¢å¤§ç¼“å†²åŒº (period_count)
â–¡ æé«˜çº¿ç¨‹ä¼˜å…ˆçº§
â–¡ é¢„å¡«å……ç¼“å†²åŒº
â–¡ ä½¿ç”¨å›è°ƒæ¨¡å¼
â–¡ é¿å…é˜»å¡æ“ä½œ
```

### 8.3 åŠŸè€—ä¼˜åŒ–

```
â–¡ ä½¿ç”¨ Deep Buffer æˆ– Offload æ¨¡å¼
â–¡ å¢å¤§ç¼“å†²åŒºå‡å°‘å”¤é†’
â–¡ åˆç†ä½¿ç”¨ standby
â–¡ é…ç½® DAPM ç”µæºç®¡ç†
â–¡ åŠ¨æ€è°ƒæ•´æ—¶é’Ÿé¢‘ç‡
```

---

## ğŸ“Œ æ€»ç»“

| ç±»åˆ« | ä¼˜åŒ–æ–¹æ³• |
|------|----------|
| **ä½å»¶è¿Ÿ** | Fast Track, AAudio mmap, å°ç¼“å†²åŒº |
| **XRUN é¢„é˜²** | å¤§ç¼“å†²åŒº, é«˜ä¼˜å…ˆçº§, poll ç­‰å¾… |
| **åŠŸè€—ä¼˜åŒ–** | Deep Buffer, Offload, DAPM, standby |
| **åˆ†æå·¥å…·** | systrace, simpleperf, dumpsys, ftrace |
| **å…³é”®å‚æ•°** | period_size, period_count, buffer_size |
